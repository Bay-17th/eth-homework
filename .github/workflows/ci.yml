name: Homework CI

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

env:
  FOUNDRY_PROFILE: ci

jobs:
  # Job 1: Auto-label based on file paths (CI-04)
  label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  # Job 2: Solidity linting (CI-01)
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Run solhint
        id: solhint
        run: |
          npx solhint 'week-*/dev/src/**/*.sol' -f sarif -o solhint.sarif || true
          npx solhint 'week-*/dev/src/**/*.sol' -f stylish
        continue-on-error: true
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: solhint.sarif
          category: solhint

  # Job 3: Format check (CI-02)
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Check Prettier formatting
        id: prettier
        run: npx prettier --check 'week-*/dev/src/**/*.sol'
        continue-on-error: true

  # Job 4: Foundry tests (CI-03)
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable
      - name: Run forge build
        run: forge build
      - name: Run forge tests
        id: test
        run: forge test -vvv
        continue-on-error: true

  # Job 5: Security scan with Slither (CI-05)
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install Foundry (for compilation)
        uses: foundry-rs/foundry-toolchain@v1
      - name: Run Slither
        uses: crytic/slither-action@v0.4.2
        id: slither
        with:
          sarif: slither.sarif
          fail-on: none
          slither-args: --exclude-informational --exclude-optimization
        continue-on-error: true
      - name: Upload Slither SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ${{ steps.slither.outputs.sarif }}
          category: slither

  # Job 6: Korean feedback summary (CI-06)
  feedback:
    needs: [lint, format, test, security]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Korean feedback summary
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## ìˆ™ì œ ì œì¶œ CI ê²°ê³¼

          | í•­ëª© | ìƒíƒœ | ì„¤ëª… |
          |------|------|------|
          | ë¦°íŠ¸ ê²€ì‚¬ | ${{ needs.lint.result == 'success' && 'âœ… í†µê³¼' || 'âš ï¸ ê²€í†  í•„ìš”' }} | ì½”ë“œ ìŠ¤íƒ€ì¼ ë° ì ì¬ì  ë¬¸ì œ ê²€ì‚¬ |
          | í¬ë§· ê²€ì‚¬ | ${{ needs.format.result == 'success' && 'âœ… í†µê³¼' || 'âš ï¸ ìˆ˜ì • í•„ìš”' }} | ì½”ë“œ í˜•ì‹ ì¼ê´€ì„± ê²€ì‚¬ |
          | í…ŒìŠ¤íŠ¸ | ${{ needs.test.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} | ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ |
          | ë³´ì•ˆ ê²€í†  | ${{ needs.security.result == 'success' && 'âœ… ì´ìƒ ì—†ìŒ' || 'ğŸ›¡ï¸ ê²€í†  í•„ìš”' }} | ë³´ì•ˆ ì·¨ì•½ì  ë¶„ì„ |

          ---

          ### ë‹¤ìŒ ë‹¨ê³„

          - **ëª¨ë‘ í†µê³¼**: PR ë¦¬ë·°ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” ğŸ‘
          - **ê²€í†  í•„ìš”**: ìœ„ í•­ëª©ë“¤ì„ í´ë¦­í•˜ì—¬ ìƒì„¸ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”
          - **ë„ì›€ í•„ìš”**: Slack #eth-homework ì±„ë„ì— ì§ˆë¬¸í•´ì£¼ì„¸ìš”

          ---
          <sub>ìë™ ìƒì„±ëœ í”¼ë“œë°±ì…ë‹ˆë‹¤. ë¬¸ì œê°€ ìˆìœ¼ë©´ ë©˜í† ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</sub>
          EOF
